<!-- 移动端友好的访客统计组件 -->
<div id="mobile-visitor-stats" class="mobile-stats-container">
  <div class="mobile-stats-box">
    <div class="mobile-stats-grid">
      <div class="mobile-stat-item">
        <span class="mobile-stat-icon">👥</span>
        <div class="mobile-stat-content">
          <div class="mobile-stat-value" id="mobile-visitor-count">...</div>
          <div class="mobile-stat-label">访客</div>
        </div>
      </div>
      
      <div class="mobile-stat-item">
        <span class="mobile-stat-icon">📅</span>
        <div class="mobile-stat-content">
          <div class="mobile-stat-value" id="mobile-today-count">...</div>
          <div class="mobile-stat-label">今日</div>
        </div>
      </div>
      
      <div class="mobile-stat-item">
        <span class="mobile-stat-icon">🌐</span>
        <div class="mobile-stat-content">
          <div class="mobile-stat-value" id="mobile-online-count">...</div>
          <div class="mobile-stat-label">在线</div>
        </div>
      </div>
    </div>
    
    <div class="mobile-location-info">
      <span class="location-emoji">📍</span>
      <span id="mobile-location-text">获取位置中...</span>
    </div>
  </div>
</div>

<style>
.mobile-stats-container {
  margin: 15px 0;
  display: none; /* 默认隐藏，通过媒体查询显示 */
}

.mobile-stats-box {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  color: white;
  border-radius: 15px;
  padding: 16px;
  box-shadow: 0 4px 20px rgba(79, 172, 254, 0.3);
  backdrop-filter: blur(10px);
}

.mobile-stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 12px;
}

.mobile-stat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 10px;
  padding: 10px 8px;
  backdrop-filter: blur(5px);
}

.mobile-stat-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.mobile-stat-content {
  flex: 1;
  min-width: 0;
}

.mobile-stat-value {
  font-size: 16px;
  font-weight: 700;
  line-height: 1.2;
  color: #fff;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.mobile-stat-label {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.8);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  margin-top: 1px;
}

.mobile-location-info {
  display: flex;
  align-items: center;
  gap: 6px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.95);
}

.location-emoji {
  font-size: 14px;
  flex-shrink: 0;
}

#mobile-location-text {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  min-width: 0;
}

/* 响应式显示控制 */
@media (max-width: 768px) {
  .visitor-stats-container {
    display: none; /* 隐藏桌面版 */
  }
  
  .mobile-stats-container {
    display: block; /* 显示移动版 */
  }
}

@media (max-width: 480px) {
  .mobile-stats-box {
    padding: 12px;
  }
  
  .mobile-stats-grid {
    gap: 8px;
    margin-bottom: 10px;
  }
  
  .mobile-stat-item {
    padding: 8px 6px;
  }
  
  .mobile-stat-icon {
    font-size: 18px;
  }
  
  .mobile-stat-value {
    font-size: 14px;
  }
  
  .mobile-stat-label {
    font-size: 10px;
  }
  
  .mobile-location-info {
    padding: 6px 8px;
    font-size: 12px;
  }
}

/* 加载动画 */
.mobile-loading {
  animation: mobilePulse 1.5s ease-in-out infinite;
}

@keyframes mobilePulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* 错误状态 */
.mobile-error {
  color: rgba(255, 255, 255, 0.6);
  font-style: italic;
}

/* 成功更新动画 */
.mobile-updated {
  animation: mobileSuccess 0.6s ease-out;
}

@keyframes mobileSuccess {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}
</style>

<script>
// 移动端访客统计脚本
(function() {
  const MobileVisitorStats = {
    init() {
      this.syncWithDesktopStats();
      this.setupMobileSpecificFeatures();
    },

    // 同步桌面版统计数据
    syncWithDesktopStats() {
      // 等待桌面版加载完成
      const checkDesktopStats = () => {
        if (window.visitorStats || window.VisitorStats) {
          this.updateMobileDisplay();
        } else {
          setTimeout(checkDesktopStats, 100);
        }
      };
      checkDesktopStats();
    },

    // 更新移动端显示
    updateMobileDisplay() {
      try {
        // 获取桌面版的数据
        const visitorCount = document.getElementById('visitor-count')?.textContent || '...';
        const todayCount = document.getElementById('today-count')?.textContent || '...';
        const onlineCount = document.getElementById('online-count')?.textContent || '...';
        const locationText = document.getElementById('location-text')?.textContent || '获取位置中...';

        // 更新移动端显示
        this.updateElement('mobile-visitor-count', visitorCount);
        this.updateElement('mobile-today-count', todayCount);
        this.updateElement('mobile-online-count', onlineCount);
        this.updateElement('mobile-location-text', this.shortenLocation(locationText));

        // 定期同步
        setTimeout(() => this.updateMobileDisplay(), 5000);
      } catch (error) {
        console.warn('移动端统计同步失败:', error);
      }
    },

    // 缩短位置文本以适应移动端
    shortenLocation(text) {
      if (!text || text.includes('失败') || text.includes('获取')) {
        return text;
      }
      
      // 如果太长，只显示城市和国家
      const parts = text.split(', ');
      if (parts.length > 2 && text.length > 20) {
        return `${parts[0]}, ${parts[parts.length - 1]}`;
      }
      
      return text.length > 25 ? text.substring(0, 22) + '...' : text;
    },

    // 更新元素
    updateElement(id, content) {
      const element = document.getElementById(id);
      if (element && element.textContent !== content) {
        element.textContent = content;
        element.classList.add('mobile-updated');
        setTimeout(() => {
          element.classList.remove('mobile-updated');
        }, 600);
      }
    },

    // 设置移动端特定功能
    setupMobileSpecificFeatures() {
      // 触摸交互
      const mobileBox = document.querySelector('.mobile-stats-box');
      if (mobileBox) {
        mobileBox.addEventListener('touchstart', function() {
          this.style.transform = 'scale(0.98)';
        });
        
        mobileBox.addEventListener('touchend', function() {
          this.style.transform = 'scale(1)';
        });
      }

      // 双击刷新
      let lastTap = 0;
      if (mobileBox) {
        mobileBox.addEventListener('touchend', (e) => {
          const currentTime = new Date().getTime();
          const tapLength = currentTime - lastTap;
          if (tapLength < 500 && tapLength > 0) {
            // 双击检测到，刷新统计
            this.refreshStats();
          }
          lastTap = currentTime;
        });
      }
    },

    // 刷新统计
    refreshStats() {
      // 显示加载状态
      const elements = ['mobile-visitor-count', 'mobile-today-count', 'mobile-online-count'];
      elements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.add('mobile-loading');
        }
      });

      // 触发桌面版刷新
      if (window.visitorStats && window.visitorStats.fetchLocationData) {
        window.visitorStats.fetchLocationData();
      }

      // 1秒后移除加载状态
      setTimeout(() => {
        elements.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.classList.remove('mobile-loading');
          }
        });
      }, 1000);
    }
  };

  // 页面加载完成后初始化移动端统计
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => MobileVisitorStats.init());
  } else {
    MobileVisitorStats.init();
  }

  // 导出到全局作用域
  window.MobileVisitorStats = MobileVisitorStats;
})();
</script>
