<!-- ‰∏ñÁïåÂú∞ÂõæËÆøÂÆ¢ÁªüËÆ°ÁªÑ‰ª∂ -->
<div id="visitor-map-stats" class="visitor-map-container">
  <div class="map-stats-header">
    <h3>üåç Visitor Analytics</h3>
    <div class="stats-summary">
      <span class="stat-item">
        <strong id="map-total-visits">0</strong> Total Visits
      </span>
      <span class="stat-item">
        <strong id="map-today-visits">0</strong> Today
      </span>
      <span class="stat-item">
        <strong id="map-online-count">0</strong> Online
      </span>
    </div>
  </div>
  
  <div class="world-map-container">
    <div class="map-wrapper">
      <!-- ÁÆÄÂåñÁöÑSVG‰∏ñÁïåÂú∞Âõæ -->
      <svg viewBox="0 0 1000 500" class="world-map">
        <defs>
          <style>
            .country { fill: #e9ecef; stroke: #dee2e6; stroke-width: 0.5; transition: all 0.3s ease; }
            .country:hover { fill: #007bff; opacity: 0.8; }
            .visitor-marker { fill: #dc3545; stroke: #fff; stroke-width: 2; animation: pulse 2s infinite; }
            @keyframes pulse {
              0% { opacity: 1; transform: scale(1); }
              50% { opacity: 0.7; transform: scale(1.2); }
              100% { opacity: 1; transform: scale(1); }
            }
          </style>
        </defs>
        
        <!-- ‰∏ªË¶ÅÂõΩÂÆ∂ÂíåÂú∞Âå∫ÁöÑÁÆÄÂåñËΩÆÂªì -->
        <g id="world-countries">
          <!-- ÂåóÁæé -->
          <path d="M150 100 L300 100 L300 200 L150 200 Z" class="country" data-country="US" title="United States"/>
          <path d="M120 80 L350 80 L350 120 L120 120 Z" class="country" data-country="CA" title="Canada"/>
          <path d="M180 200 L280 200 L280 250 L180 250 Z" class="country" data-country="MX" title="Mexico"/>
          
          <!-- ÂçóÁæé -->
          <path d="M200 270 L280 270 L280 400 L200 400 Z" class="country" data-country="BR" title="Brazil"/>
          
          <!-- Ê¨ßÊ¥≤ -->
          <path d="M420 120 L520 120 L520 180 L420 180 Z" class="country" data-country="EU" title="Europe"/>
          
          <!-- ‰∫öÊ¥≤ -->
          <path d="M600 100 L800 100 L800 250 L600 250 Z" class="country" data-country="CN" title="China"/>
          <path d="M720 120 L820 120 L820 200 L720 200 Z" class="country" data-country="JP" title="Japan"/>
          <path d="M580 200 L680 200 L680 280 L580 280 Z" class="country" data-country="IN" title="India"/>
          
          <!-- ÈùûÊ¥≤ -->
          <path d="M450 200 L550 200 L550 350 L450 350 Z" class="country" data-country="AF" title="Africa"/>
          
          <!-- Â§ßÊ¥ãÊ¥≤ -->
          <path d="M750 300 L850 300 L850 380 L750 380 Z" class="country" data-country="AU" title="Australia"/>
        </g>
        
        <!-- ËÆøÂÆ¢Ê†áËÆ∞ÁÇπ -->
        <g id="visitor-markers">
          <!-- ËøôÈáå‰ºöÂä®ÊÄÅÊ∑ªÂä†ËÆøÂÆ¢‰ΩçÁΩÆÊ†áËÆ∞ -->
        </g>
      </svg>
    </div>
    
    <div class="map-info">
      <div class="current-visitor">
        <div class="visitor-location-info">
          <span class="location-icon">üìç</span>
          <span id="current-location">Getting your location...</span>
        </div>
        <div class="visitor-details">
          <span class="detail-item">
            <i class="fas fa-globe"></i>
            <span id="current-ip">-</span>
          </span>
          <span class="detail-item">
            <i class="fas fa-clock"></i>
            <span id="current-time-map">-</span>
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="recent-visitors">
    <h4>Recent Visitors</h4>
    <div id="recent-visitors-list" class="visitors-list">
      <!-- Âä®ÊÄÅÁîüÊàêÊúÄËøëËÆøÂÆ¢ÂàóË°® -->
    </div>
  </div>
</div>

<style>
.visitor-map-container {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  margin: 30px 0;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  border: 1px solid #e9ecef;
}

.map-stats-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid #e9ecef;
}

.map-stats-header h3 {
  margin: 0;
  color: #495057;
  font-size: 20px;
}

.stats-summary {
  display: flex;
  gap: 20px;
}

.stats-summary .stat-item {
  font-size: 14px;
  color: #6c757d;
}

.stats-summary .stat-item strong {
  color: #007bff;
  font-size: 18px;
  display: block;
}

.world-map-container {
  position: relative;
}

.map-wrapper {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 15px;
}

.world-map {
  width: 100%;
  height: auto;
  max-height: 300px;
}

.map-info {
  background: #f8f9fa;
  border-radius: 6px;
  padding: 15px;
  margin-bottom: 15px;
}

.current-visitor {
  text-align: center;
}

.visitor-location-info {
  font-size: 16px;
  font-weight: 500;
  color: #495057;
  margin-bottom: 10px;
}

.location-icon {
  font-size: 18px;
  margin-right: 8px;
}

.visitor-details {
  display: flex;
  justify-content: center;
  gap: 20px;
  font-size: 13px;
  color: #6c757d;
}

.detail-item {
  display: flex;
  align-items: center;
  gap: 5px;
}

.recent-visitors {
  border-top: 1px solid #e9ecef;
  padding-top: 15px;
}

.recent-visitors h4 {
  margin: 0 0 15px 0;
  color: #495057;
  font-size: 16px;
}

.visitors-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10px;
}

.visitor-entry {
  background: #f8f9fa;
  border-radius: 6px;
  padding: 10px 12px;
  font-size: 13px;
  border-left: 3px solid #007bff;
}

.visitor-entry .visitor-flag {
  margin-right: 8px;
}

.visitor-entry .visitor-time {
  color: #6c757d;
  font-size: 11px;
  display: block;
  margin-top: 5px;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .map-stats-header {
    flex-direction: column;
    gap: 15px;
    text-align: center;
  }
  
  .stats-summary {
    justify-content: center;
    flex-wrap: wrap;
    gap: 15px;
  }
  
  .visitor-details {
    flex-direction: column;
    gap: 8px;
  }
  
  .visitors-list {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  .visitor-map-container {
    padding: 15px;
  }
  
  .map-wrapper {
    padding: 15px;
  }
  
  .stats-summary {
    gap: 10px;
  }
  
  .stats-summary .stat-item {
    font-size: 13px;
  }
  
  .stats-summary .stat-item strong {
    font-size: 16px;
  }
}

/* Âä®ÁîªÊïàÊûú */
.fade-in-map {
  animation: fadeInMap 0.5s ease-in;
}

@keyframes fadeInMap {
  from { 
    opacity: 0; 
    transform: translateY(20px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

.country-highlight {
  fill: #28a745 !important;
  opacity: 0.8;
}
</style>

<script>
// ‰∏ñÁïåÂú∞ÂõæËÆøÂÆ¢ÁªüËÆ°ËÑöÊú¨
class WorldMapVisitorStats {
  constructor() {
    this.config = {
      maxRecentVisitors: 10,
      updateInterval: 30000, // 30ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
      countryCoordinates: {
        'CN': { x: 700, y: 175, name: 'China' },
        'US': { x: 225, y: 150, name: 'United States' },
        'JP': { x: 770, y: 160, name: 'Japan' },
        'KR': { x: 750, y: 140, name: 'South Korea' },
        'GB': { x: 450, y: 120, name: 'United Kingdom' },
        'DE': { x: 470, y: 130, name: 'Germany' },
        'FR': { x: 445, y: 140, name: 'France' },
        'CA': { x: 235, y: 100, name: 'Canada' },
        'AU': { x: 800, y: 340, name: 'Australia' },
        'IN': { x: 630, y: 240, name: 'India' },
        'BR': { x: 240, y: 335, name: 'Brazil' },
        'RU': { x: 650, y: 120, name: 'Russia' }
      }
    };
    
    this.recentVisitors = this.loadRecentVisitors();
    this.init();
  }

  init() {
    this.syncWithMainStats();
    this.updateCurrentTime();
    this.startPeriodicUpdates();
    this.setupInteractions();
  }

  // ÂêåÊ≠•‰∏ªÁªüËÆ°Êï∞ÊçÆ
  syncWithMainStats() {
    // Á≠âÂæÖ‰∏ªÁªüËÆ°Âä†ËΩΩ
    const checkMainStats = () => {
      if (window.visitorStats) {
        this.updateStatsDisplay();
        this.updateCurrentVisitor();
      } else {
        setTimeout(checkMainStats, 100);
      }
    };
    checkMainStats();
  }

  // Êõ¥Êñ∞ÁªüËÆ°ÊòæÁ§∫
  updateStatsDisplay() {
    try {
      const mainStats = window.visitorStats.stats;
      const today = window.visitorStats.getDateKey(Date.now());
      const todayStats = mainStats.dailyStats[today] || { visits: 0 };
      const onlineCount = window.visitorStats.calculateOnlineUsers();

      this.updateElement('map-total-visits', this.formatNumber(mainStats.totalVisits));
      this.updateElement('map-today-visits', this.formatNumber(todayStats.visits));
      this.updateElement('map-online-count', onlineCount);
    } catch (error) {
      console.warn('Failed to sync with main stats:', error);
    }
  }

  // Êõ¥Êñ∞ÂΩìÂâçËÆøÂÆ¢‰ø°ÊÅØ
  async updateCurrentVisitor() {
    try {
      // Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ‰ø°ÊÅØ
      if (window.visitorStats && window.visitorStats.cache.locationData) {
        const data = window.visitorStats.cache.locationData;
        this.displayCurrentVisitor(data);
        this.addVisitorToMap(data);
        this.addToRecentVisitors(data);
      } else {
        // Â¶ÇÊûúËøòÊ≤°Êúâ‰ΩçÁΩÆÊï∞ÊçÆÔºåÁ≠âÂæÖËé∑Âèñ
        setTimeout(() => this.updateCurrentVisitor(), 1000);
      }
    } catch (error) {
      console.warn('Failed to update current visitor:', error);
    }
  }

  // ÊòæÁ§∫ÂΩìÂâçËÆøÂÆ¢
  displayCurrentVisitor(data) {
    if (data.error) {
      this.updateElement('current-location', 'Location unavailable');
      this.updateElement('current-ip', 'Unknown');
      return;
    }

    const location = this.formatLocation(data);
    const flag = this.getCountryFlag(data.countryCode);
    
    this.updateElement('current-location', `${flag} ${location}`);
    this.updateElement('current-ip', this.maskIP(data.ip));
  }

  // Âú®Âú∞Âõæ‰∏äÊ∑ªÂä†ËÆøÂÆ¢Ê†áËÆ∞
  addVisitorToMap(data) {
    if (data.error || !data.countryCode) return;

    const coords = this.config.countryCoordinates[data.countryCode.toUpperCase()];
    if (!coords) return;

    // È´ò‰∫ÆÂØπÂ∫îÂõΩÂÆ∂
    this.highlightCountry(data.countryCode);

    // Ê∑ªÂä†ËÆøÂÆ¢Ê†áËÆ∞ÁÇπ
    const markersGroup = document.getElementById('visitor-markers');
    if (markersGroup) {
      // Ê∏ÖÈô§‰πãÂâçÁöÑÊ†áËÆ∞
      markersGroup.innerHTML = '';
      
      // Ê∑ªÂä†Êñ∞Ê†áËÆ∞
      const marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      marker.setAttribute('cx', coords.x);
      marker.setAttribute('cy', coords.y);
      marker.setAttribute('r', '5');
      marker.setAttribute('class', 'visitor-marker');
      marker.setAttribute('title', `Current visitor from ${coords.name}`);
      
      markersGroup.appendChild(marker);
    }
  }

  // È´ò‰∫ÆÂõΩÂÆ∂
  highlightCountry(countryCode) {
    // ÈáçÁΩÆÊâÄÊúâÂõΩÂÆ∂
    document.querySelectorAll('.country').forEach(country => {
      country.classList.remove('country-highlight');
    });

    // È´ò‰∫ÆÂΩìÂâçÂõΩÂÆ∂
    const country = document.querySelector(`[data-country="${countryCode.toUpperCase()}"]`);
    if (country) {
      country.classList.add('country-highlight');
    }
  }

  // Ê∑ªÂä†Âà∞ÊúÄËøëËÆøÂÆ¢ÂàóË°®
  addToRecentVisitors(data) {
    if (data.error) return;

    const visitor = {
      location: this.formatLocation(data),
      flag: this.getCountryFlag(data.countryCode),
      time: new Date().toLocaleString(),
      timestamp: Date.now()
    };

    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÔºàÈò≤Ê≠¢ÈáçÂ§çÔºâ
    const exists = this.recentVisitors.some(v => 
      v.location === visitor.location && 
      (visitor.timestamp - v.timestamp) < 3600000 // 1Â∞èÊó∂ÂÜÖ
    );

    if (!exists) {
      this.recentVisitors.unshift(visitor);
      this.recentVisitors = this.recentVisitors.slice(0, this.config.maxRecentVisitors);
      this.saveRecentVisitors();
      this.updateRecentVisitorsList();
    }
  }

  // Êõ¥Êñ∞ÊúÄËøëËÆøÂÆ¢ÂàóË°®ÊòæÁ§∫
  updateRecentVisitorsList() {
    const listElement = document.getElementById('recent-visitors-list');
    if (!listElement) return;

    if (this.recentVisitors.length === 0) {
      listElement.innerHTML = '<div class="visitor-entry">No recent visitors yet</div>';
      return;
    }

    listElement.innerHTML = this.recentVisitors.map(visitor => `
      <div class="visitor-entry fade-in-map">
        <span class="visitor-flag">${visitor.flag}</span>
        <span class="visitor-location">${visitor.location}</span>
        <span class="visitor-time">${this.getRelativeTime(visitor.timestamp)}</span>
      </div>
    `).join('');
  }

  // Ëé∑ÂèñÁõ∏ÂØπÊó∂Èó¥
  getRelativeTime(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    
    if (diff < 60000) return 'Just now';
    if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
    return `${Math.floor(diff / 86400000)}d ago`;
  }

  // Êõ¥Êñ∞ÂΩìÂâçÊó∂Èó¥
  updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleString('en-US', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
    
    this.updateElement('current-time-map', timeString);
  }

  // ËÆæÁΩÆ‰∫§‰∫í
  setupInteractions() {
    // ÂõΩÂÆ∂ÊÇ¨ÂÅúÊïàÊûú
    document.querySelectorAll('.country').forEach(country => {
      country.addEventListener('mouseenter', function() {
        const title = this.getAttribute('title');
        if (title) {
          this.setAttribute('data-tooltip', title);
        }
      });
    });
  }

  // ÂºÄÂßãÂë®ÊúüÊÄßÊõ¥Êñ∞
  startPeriodicUpdates() {
    setInterval(() => {
      this.updateCurrentTime();
      this.updateStatsDisplay();
    }, this.config.updateInterval);

    // ÊØèÁßíÊõ¥Êñ∞Êó∂Èó¥
    setInterval(() => {
      this.updateCurrentTime();
    }, 1000);
  }

  // Â∑•ÂÖ∑ÊñπÊ≥ï
  formatLocation(data) {
    const parts = [data.city, data.region, data.country].filter(Boolean);
    return parts.length > 0 ? parts.join(', ') : 'Unknown Location';
  }

  getCountryFlag(countryCode) {
    if (!countryCode || countryCode.length !== 2) return '';
    
    const flagMap = {
      'CN': 'üá®üá≥', 'US': 'üá∫üá∏', 'JP': 'üáØüáµ', 'KR': 'üá∞üá∑', 
      'GB': 'üá¨üáß', 'FR': 'üá´üá∑', 'DE': 'üá©üá™', 'CA': 'üá®üá¶',
      'AU': 'üá¶üá∫', 'IN': 'üáÆüá≥', 'BR': 'üáßüá∑', 'RU': 'üá∑üá∫'
    };
    
    return flagMap[countryCode.toUpperCase()] || 'üåç';
  }

  maskIP(ip) {
    if (!ip || ip === 'Unknown') return ip;
    
    if (ip.includes('.')) {
      const parts = ip.split('.');
      return `${parts[0]}.${parts[1]}.*.***`;
    } else if (ip.includes(':')) {
      const parts = ip.split(':');
      return parts.slice(0, 3).join(':') + ':****';
    }
    
    return ip;
  }

  formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
  }

  updateElement(id, content) {
    const element = document.getElementById(id);
    if (element) {
      element.textContent = content;
    }
  }

  // Êï∞ÊçÆÊåÅ‰πÖÂåñ
  loadRecentVisitors() {
    try {
      const stored = localStorage.getItem('recent_visitors');
      return stored ? JSON.parse(stored) : [];
    } catch (error) {
      return [];
    }
  }

  saveRecentVisitors() {
    try {
      localStorage.setItem('recent_visitors', JSON.stringify(this.recentVisitors));
    } catch (error) {
      console.warn('Failed to save recent visitors:', error);
    }
  }
}

// ÂàùÂßãÂåñ‰∏ñÁïåÂú∞ÂõæÁªüËÆ°
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    window.worldMapStats = new WorldMapVisitorStats();
  });
} else {
  window.worldMapStats = new WorldMapVisitorStats();
}
</script>
